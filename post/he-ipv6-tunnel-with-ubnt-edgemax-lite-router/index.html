<!doctype html><html lang=en>
<head>
<title>
HE IPv6 tunnel with Ubnt EdgeMax Lite router | Thoughts, Links & Moods
</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=HandheldFriendly content="True">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="jason.re • Thoughts, Links & Moods">
<meta name=author content="Jason Friedrich">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="HE IPv6 tunnel with Ubnt EdgeMax Lite router">
<meta name=twitter:description content="IPv6 gets more and more important. I think 2016 will be the year when it get’s adopted on a large scale and will finally start to be mandatory with every new Internet connection — at least in a Dual Stack configuration.">
<meta property="og:title" content="HE IPv6 tunnel with Ubnt EdgeMax Lite router">
<meta property="og:description" content="IPv6 gets more and more important. I think 2016 will be the year when it get’s adopted on a large scale and will finally start to be mandatory with every new Internet connection — at least in a Dual Stack configuration.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jason.re/post/he-ipv6-tunnel-with-ubnt-edgemax-lite-router/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-01-02T21:26:15+01:00">
<meta property="article:modified_time" content="2022-02-20T02:30:06+00:00">
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;700&display=swap" rel=stylesheet>
<link rel=preconnect href=https://cdn.jsdelivr.net>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css>
<link rel=stylesheet type=text/css href=/css/highlightjs/tomorrow-night.css>
<link rel=stylesheet href=/css/style.min.css>
<link rel="shortcut icon" href=/favicon.ico>
<script src=/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</head>
<body id=top class=main>
<header class=header>
<div class=header-logo>
<img class=logo title=About srcset="/images/author_hu737cdb9bf67d3c24ce670e322a5be00e_255619_122x0_resize_box_3.png, /images/author_hu737cdb9bf67d3c24ce670e322a5be00e_255619_244x0_resize_box_3.png 2x" alt="Blog Logo" src=/images/author_hu737cdb9bf67d3c24ce670e322a5be00e_255619_244x0_resize_box_3.png>
</div>
<h1 class=blog-title>Thoughts, Links & Moods</h1>
<nav class=header-nav>
<div class=grid-canvas>
<div class=primary-nav>
<a class=header-nav-entry title=Home href=/><i role=img class="bi bi-house-fill"></i><span>Home</span></a>
<a class=header-nav-entry title=About href=/about/><i role=img class="bi bi-person-fill"></i><span>About</span></a>
<a class=header-nav-entry title=Twitter href=https://twitter.com/jbfriedrich><i role=img class="bi bi-twitter"></i><span>Twitter</span></a>
</div>
</div>
</nav>
</header>
<main class=content>
<article class="full-post type-post">
<header class="post-header grid-canvas">
<h2 class=post-date>January 2, 2016</h2>
<h1 class="post-title has-summary has-feature-image">HE IPv6 tunnel with Ubnt EdgeMax Lite router</h1>
<div class="post-summary has-feature-image">IPv6 gets more and more important. I think 2016 will be the year when it get’s adopted on a large scale and will finally start to be mandatory with every new Internet connection — at least in a Dual Stack configuration.</div>
<figure class="figure feature-figure">
<img alt="Page Feature Image" class=feature-image src="https://images.unsplash.com/photo-1528845922818-cc5462be9a63?ixlib=rb-0.3.5&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ&s=070a3027c856334de5b5432d83226cc7">
</figure>
</header>
<main class="post-content grid-canvas">
<p>My web and DNS servers are available via <a href=https://en.wikipedia.org/wiki/IPv6>IPv6</a> for a while now. There is not much demand (yet) for it, but it’s available for users who wan’t/can use it. Because IPv6 is currently not that widely spread, I hesitated for a long time to put up the effort to configure a proper IPv6 tunnel at home.</p>
<p>Well, I had some spare time on my hands and stumbled upon some <a href=https://www.reddit.com/r/Ubiquiti/comments/33zkhu/useful_edgerouter_cli_commands_settings/>interesting</a> <a href=https://community.ubnt.com/t5/EdgeMAX/tunnelbroker-hurricane-electric-IPV6-tunnel-config-question/m-p/424813#M6390>sites</a> on the Internet. So let’s go!</p>
<h1 id=availability-of-ipv6>Availability of IPv6</h1>
<p>It looks like no company is providing native IPv6 access to the Internet — at least on the consumer level or for small business accounts. According to some online publications, Deutsche Telekom has already started their IPv6 rollout in their networking — including their cellular network in Germany. They have supposedly chosen to use <a href=https://en.wikipedia.org/wiki/IPv6#Dual_IP_stack_implementation>Dual Stack</a> for the transition period. I say “supposedly” because I use a different provider at home and my T-Mobile cell phone internet access seems to be IPv4 only, so I cannot verify it.</p>
<h1 id=dual-stack-where-you-can-tunnel-where-you-must>Dual stack where you can; tunnel where you must</h1>
<p>There are several tunnel brokers available on the Internet. <a href=https://www.sixxs.net/>Sixxs</a> disqualified itself years ago with an extraordinarily arrogant attitude that annoys the hell out of me, so I chose to use <a href=https://www.tunnelbroker.net/>Hurricane Electric</a>. This choice really was a no-brainer, as I also use their <a href=https://dns.he.net/>DNS services</a> for quite some time now and never had any problems.</p>
<h1 id=lets-dig-a-tunnel>Let’s dig a tunnel</h1>
<p>Firs things first, <a href=https://www.tunnelbroker.net/register.php>register with Hurricane Electric</a> and create a tunnel. The creation wizard will show you all required information — like your IPv4 tunnel endpoints and your IPv6 subnet(s). The <a href=https://www.ubnt.com/edgemax/edgerouter-lite/>Ubiquiti EdgeMax Lite router</a> that I use is a quite versatile and powerful little thing. Log in via SSH and start creating the tunnel:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>configure
edit interfaces tunnel tun0 set encapsulation sit
set local-ip &lt;Client IPv4 Address&gt;
set remote-ip &lt;Server IPv4 Address&gt;
set address &lt;Client IPv6 Address&gt;
set description <span style=color:#e6db74>&#34;HE.NET IPv6 Tunnel&#34;</span>
exit 
set protocols static interface-route6 ::/0 next-hop-interface tun0
commit
save
</code></pre></div><p>You now should be able to ping the server IPv6 address and your tunnel is established.</p>
<h1 id=configure-interfaces-and-network-address>Configure interfaces and network address</h1>
<p>Now configure your internal network. HE will route a /64 prefix to you, so choose an IP address from your new network and assign it to your internal network (usually the ::1 address). Also configure the router to advertise it’s network on the internal interface so that clients can automatically get an IPv6 IP address:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set interfaces ethernet eth1 address <span style=color:#e6db74>&#39;&lt;IPv6 router IP&gt;&#39;</span>
set interfaces ethernet eth1 ipv6 dup-addr-detect-transmits <span style=color:#ae81ff>1</span>
set interfaces ethernet eth1 ipv6 router-advert cur-hop-limit <span style=color:#ae81ff>64</span>
set interfaces ethernet eth1 ipv6 router-advert link-mtu <span style=color:#ae81ff>0</span>
set interfaces ethernet eth1 ipv6 router-advert managed-flag false
set interfaces ethernet eth1 ipv6 router-advert max-interval <span style=color:#ae81ff>300</span>
set interfaces ethernet eth1 ipv6 router-advert other-config-flag false
set interfaces ethernet eth1 ipv6 router-advert prefix <span style=color:#e6db74>&#39;2001:xx:xxxx:xxxx::/64&#39;</span> autonomous-flag true
set interfaces ethernet eth1 ipv6 router-advert prefix <span style=color:#e6db74>&#39;2001:xx:xxxx:xxxx::/64&#39;</span> on-link-flag true
set interfaces ethernet eth1 ipv6 router-advert prefix <span style=color:#e6db74>&#39;2001:xx:xxxx:xxxx::/64&#39;</span> valid-lifetime <span style=color:#ae81ff>2592000</span>
set interfaces ethernet eth1 ipv6 router-advert reachable-time <span style=color:#ae81ff>0</span>
set interfaces ethernet eth1 ipv6 router-advert retrans-timer <span style=color:#ae81ff>0</span>
set interfaces ethernet eth1 ipv6 router-advert send-advert true
</code></pre></div><h1 id=change-default-ports-for-http-gui-and-ssh>Change Default Ports For HTTP GUI and SSH</h1>
<p>For security reasons change the service ports for the router’s web UI and SSH access to something else, as your IPv6 IP <strong>is reachable from the Internet now!</strong> I think this will be the most important thing to think about during the transition to IPv6 — no “security” by IPv4 NAT anymore. Everything is accessible on the Internet — if not properly shielded by a firewall on the router or the asset itself!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set service ssh port <span style=color:#ae81ff>8022</span>
set service gui https-port <span style=color:#ae81ff>8443</span>
</code></pre></div><h1 id=common-useful-address-groups>Common Useful Address Groups</h1>
<p>Set up some groups to make handling of these special address ranges easier in the future:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set firewall group address-group Private-RFC-Ranges description <span style=color:#e6db74>&#39;RFC 1918 Private Ranges&#39;</span>
set firewall group address-group Private-RFC-Ranges address 10.0.0.0/8
set firewall group address-group Private-RFC-Ranges address 172.16.0.0/12
set firewall group address-group Private-RFC-Ranges address 192.168.0.0/16
set firewall group ipv6-address-group IPv6-FE80 description <span style=color:#e6db74>&#39;fe80::/10 (aka Link-Local) Network&#39;</span>
set firewall group ipv6-address-group IPv6-FE80 ipv6-network <span style=color:#e6db74>&#39;fe80::/10&#39;</span>
</code></pre></div><h1 id=enable-hardware-offloading>Enable Hardware Offloading</h1>
<p>The EdgeMax Lite router offers hardware offloading, so let’s use it!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set system offload ipsec enable
set system offload ipv4 forwarding enable
set system offload ipv4 vlan enable
set system offload ipv6 forwarding enable
set system offload ipv6 vlan enable
</code></pre></div><p>If you are using DSL, it might also be a good idea to enable this</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set system offload ipv4 pppoe enable
set system offload ipv6 pppoe disable
</code></pre></div><h2 id=optional-configure-mss-clamping-on-dsl-connections>Optional: Configure MSS Clamping on DSL connections</h2>
<p>Some sites on the Internet have problems with <a href=https://en.wikipedia.org/wiki/Path_MTU_Discovery>PMTU discovery</a>, so it is best to clamp the MSS manually. For PPPoE users, this command will ‘fix’ connectivity to remote sites where ICMP is blocked, and PMTU is broken:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set firewall options mss-clamp interface-type all
set firewall options mss-clamp mss <span style=color:#ae81ff>1452</span>
set firewall options mss-clamp6 interface-type all
set firewall options mss-clamp6 mss <span style=color:#ae81ff>1412</span>
</code></pre></div><h1 id=configuring-the-firewall>Configuring the firewall</h1>
<p>Last but not least, define a set of firewall rules to make sure you are safe and sound:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set firewall ipv6-name HE-To-LAN default-action drop
set firewall ipv6-name HE-to-LAN description <span style=color:#e6db74>&#39;HE to LAN&#39;</span>
set firewall ipv6-name HE-to-LAN rule <span style=color:#ae81ff>1</span> action accept
set firewall ipv6-name HE-to-LAN rule <span style=color:#ae81ff>1</span> description <span style=color:#e6db74>&#39;Drop non-related incoming IPv6&#39;</span>
set firewall ipv6-name HE-to-LAN rule <span style=color:#ae81ff>1</span> state established enable
set firewall ipv6-name HE-to-LAN rule <span style=color:#ae81ff>1</span> state related enable
set firewall ipv6-name HE-to-LAN rule <span style=color:#ae81ff>2</span> action drop
set firewall ipv6-name HE-to-LAN rule <span style=color:#ae81ff>2</span> state invalid enable

set firewall ipv6-name LAN-to-HE default-action accept
set firewall ipv6-name LAN-to-HE description <span style=color:#e6db74>&#39;LAN to HE&#39;</span>
set firewall ipv6-name LAN-to-HE rule <span style=color:#ae81ff>1</span> action accept
set firewall ipv6-name LAN-to-HE rule <span style=color:#ae81ff>1</span> state established enable
set firewall ipv6-name LAN-to-HE rule <span style=color:#ae81ff>1</span> state related enable
set firewall ipv6-name LAN-to-HE rule <span style=color:#ae81ff>2</span> action drop
set firewall ipv6-name LAN-to-HE rule <span style=color:#ae81ff>2</span> state invalid enable
</code></pre></div><p>The first rule-set will drop all incoming IPv6 traffic unless it is related, while the second rule-set will by default accept all traffic. Now we have to assign these rule-sets to the interfaces we have.</p>
<h2 id=traffic-to-the-router-and-your-ipv6-network>Traffic to the router and your IPv6 network</h2>
<p>Assign the HE-to-LAN ruleset for forwarded packets on the inbound tunnel interface <strong>and</strong> and for packets destined for the router itself:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set interfaces tunnel tun0 firewall in ipv6-name HE-to-LAN
set interfaces tunnel tun0 firewall local ipv6-name HE-to-LAN
</code></pre></div><h2 id=traffic-from-the-lan-to-the-ipv6-internet>Traffic from the LAN to the IPv6 internet</h2>
<p>This rule-set will allow traffic from the inside to the Internet via IPv6:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>set interfaces ethernet eth1 firewall in ipv6-name LAN-to-HE
</code></pre></div><p>Congratulations. You are now able to use IPv6! To make sure everything went alright, <a href=http://www.ipv6scanner.com/cgi-bin/main.py>test your firewall</a> and your general <a href=http://ipv6-test.com/>IPv6 connectivity</a> and work towards your 20/20 rating!</p>
<figure class="figure image-figure">
<img class=image src=https://rmbr.eu/file/dstore/16/1/CXe4EP6WYAEvSlN.jpg alt="IPv6 Test">
<figcaption class="figure-caption image-figure-caption">IPv6 Test</figcaption>
</figure>
</main>
<aside class="tags grid-canvas">
<ul class=taglist>
<li class=tag><a class=tag-link href=/tags/ipv6 title="Posts tagged with ipv6"><i class="bi bi-tag"></i>ipv6</a></li>
<li class=tag><a class=tag-link href=/tags/networking title="Posts tagged with networking"><i class="bi bi-tag"></i>networking</a></li>
<li class=tag><a class=tag-link href=/tags/en title="Posts tagged with en"><i class="bi bi-tag"></i>en</a></li>
</ul>
</aside>
</article>
</main>
<div class=footer>
<div class=grid-canvas>
<div class=footer-nav>
<div class=notice>© 2022 Jason Friedrich</div>
<nav class=header-nav>
<div class=secondary-nav>
<a class="header-nav-entry desktop-nav-entry" title=Home href=/><i role=img class="bi bi-house-fill"></i><span>Home</span></a>
<a class="header-nav-entry desktop-nav-entry" title=About href=/about/><i role=img class="bi bi-person-fill"></i><span>About</span></a>
<a class="header-nav-entry desktop-nav-entry" title=Twitter href=https://twitter.com/jbfriedrich><i role=img class="bi bi-twitter"></i><span>Twitter</span></a>
<a class=header-nav-entry title="Top " href=#top>&#8593; Top &#8593;</a>
</div>
</nav>
</div>
</div>
</div>
</body>
</html>
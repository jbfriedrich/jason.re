<!doctype html><html lang=en>
<head>
<title>
VPN with Wireguard on macOS & iOS | Thoughts, Links & Moods
</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=HandheldFriendly content="True">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="jason.re • Thoughts, Links & Moods">
<meta name=author content="Jason Friedrich">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="VPN with Wireguard on macOS & iOS">
<meta name=twitter:description content="I read and hear a lot about Wireguard the last couple of weeks. Even Linus Torvalds seems to like it – and praise like that is not easy to achieve. When people say so many good things about it, I should give it a try. I was looking for an OpenVPN alternative anyway.">
<meta property="og:title" content="VPN with Wireguard on macOS & iOS">
<meta property="og:description" content="I read and hear a lot about Wireguard the last couple of weeks. Even Linus Torvalds seems to like it – and praise like that is not easy to achieve. When people say so many good things about it, I should give it a try. I was looking for an OpenVPN alternative anyway.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jason.re/post/vpn-with-wireguard-on-macos-ios/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-02-28T03:04:34+01:00">
<meta property="article:modified_time" content="2022-02-17T23:00:26+00:00">
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;700&display=swap" rel=stylesheet>
<link rel=preconnect href=https://cdn.jsdelivr.net>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css>
<link rel=stylesheet type=text/css href=/css/highlightjs/tomorrow-night.css>
<link rel=stylesheet href=/css/style.min.css>
<link rel="shortcut icon" href=/favicon.ico>
<script src=/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</head>
<body id=top class=main>
<header class=header>
<div class=header-logo>
<img class=logo title=About srcset="/images/author_hu737cdb9bf67d3c24ce670e322a5be00e_255619_122x0_resize_box_3.png, /images/author_hu737cdb9bf67d3c24ce670e322a5be00e_255619_244x0_resize_box_3.png 2x" alt="Blog Logo" src=/images/author_hu737cdb9bf67d3c24ce670e322a5be00e_255619_244x0_resize_box_3.png>
</div>
<h1 class=blog-title>Thoughts, Links & Moods</h1>
<nav class=header-nav>
<div class=grid-canvas>
<div class=primary-nav>
<a class=header-nav-entry title=Home href=/><i role=img class="bi bi-house-fill"></i><span>Home</span></a>
<a class=header-nav-entry title=About href=/about/><i role=img class="bi bi-person-fill"></i><span>About</span></a>
<a class=header-nav-entry title=Twitter href=https://twitter.com/jbfriedrich><i role=img class="bi bi-twitter"></i><span>Twitter</span></a>
</div>
</div>
</nav>
</header>
<main class=content>
<article class="full-post type-post">
<header class="post-header grid-canvas">
<h2 class=post-date>February 28, 2019</h2>
<h1 class="post-title has-feature-image">VPN with Wireguard on macOS & iOS</h1>
<figure class="figure feature-figure">
<img alt="Page Feature Image" class=feature-image src="https://images.unsplash.com/photo-1535191042502-e6a9a3d407e7?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ">
</figure>
</header>
<main class="post-content grid-canvas">
<p>I read and hear a lot about <a href=https://www.wireguard.com>Wireguard</a> the last couple of weeks. Even Linus Torvalds <a href=http://lkml.iu.edu/hypermail/linux/kernel/1808.0/02472.html>seems to like it</a> – and praise like that is not easy to achieve. When people say so many good things about it, I should give it a try. I was looking for an OpenVPN alternative anyway.</p>
<h2 id=installation>Installation</h2>
<p>I expected some kind of &ldquo;Piped Bash Script&rdquo; installer, but Wireguard has prepared packages for almost every <a href=https://www.wireguard.com/install/>Linux distribution</a>. There is even a <a href="https://itunes.apple.com/us/app/wireguard/id1451685025?ls=1&mt=12">macOS app</a> and an <a href="https://itunes.apple.com/us/app/wireguard/id1441195209?ls=1&mt=8">iOS app</a> available in the app stores. This was the first, but not the only time I was impressed with Wireguard.</p>
<p>As underlying OS for the VPN server, I used the latest version of <a href=https://www.ubuntu.com/download/server>Ubuntu LTS</a>. The well-known simple command triplet starts the installation of the required components:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># Adding the reposistory from PPA</span>
$ sudo add-apt-repository ppa:wireguard/wireguard

<span style=color:#75715e># Installing required packages</span>
$ sudo apt-get update
$ sudo apt-get install wireguard linux-headers-4.15.0-45-generic iptables

<span style=color:#75715e># Generating and loading the wireguard kernel module</span>
$ dkms autoinstall
$ modprobe wireguard

<span style=color:#75715e># Enabling package forwarding for the VPN clients</span>
$ echo <span style=color:#e6db74>&#39;net.ipv4.ip_forward = 1&#39;</span> &gt;&gt; /etc/sysctl.conf
$ sysctl -p /etc/sysctl.conf
</code></pre></div><p>For iOS I just downloaded the app from the app store. For macOS I did not use the app, but decided to install all required components via <a href=https://brew.sh>brew</a>, so that could start and stop the VPN from my Fish console:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ brew install wireguard-tools qrencode
</code></pre></div><h2 id=configuration>Configuration</h2>
<p>This was the second surprise. After a very painless and easy installation, the configuration was also straightforward. Most of the steps are identical, no matter if it is the client or the server. So lets start with generating all the required keys:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#66d9ef>for</span> device in server client ios
<span style=color:#66d9ef>do</span>
    wg genkey &gt; <span style=color:#e6db74>${</span>device<span style=color:#e6db74>}</span>.privkey <span style=color:#f92672>&amp;&amp;</span>
    wg pubkey &lt; <span style=color:#e6db74>${</span>device<span style=color:#e6db74>}</span>.privkey &gt; <span style=color:#e6db74>${</span>device<span style=color:#e6db74>}</span>.pubkey <span style=color:#f92672>&amp;&amp;</span>
    wg genpsk &gt; preshared.key <span style=color:#f92672>&amp;&amp;</span> 
    chmod <span style=color:#ae81ff>0600</span> <span style=color:#e6db74>${</span>device<span style=color:#e6db74>}</span>.privkey <span style=color:#e6db74>${</span>device<span style=color:#e6db74>}</span>.pubkey preshared.key
<span style=color:#66d9ef>done</span>
</code></pre></div><p>Now that we have generated the required private and public key files for all parties involved, we can create the config files. The VPN server first:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># /etc/wireguard/wg0.conf</span>

<span style=color:#75715e># The internal IP address of the VPN server that is used over the VPN</span>
Address <span style=color:#f92672>=</span> 10.0.0.1/24

<span style=color:#75715e># Commands to tbe run after the VPN interface is started or stopped.</span>
<span style=color:#75715e># This is required to enable the server to act as a NAT gateway.</span>
<span style=color:#75715e># Please replace &#39;eth0&#39; with your actual network device name!</span>
PostUp <span style=color:#f92672>=</span> iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown <span style=color:#f92672>=</span> iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

<span style=color:#75715e># Port that the server listens on</span>
ListenPort <span style=color:#f92672>=</span> <span style=color:#ae81ff>51820</span>
<span style=color:#75715e># Private key</span>
PrivateKey <span style=color:#f92672>=</span> &lt;insert value from server.privkey here&gt;

<span style=color:#f92672>[</span>Peer<span style=color:#f92672>]</span>
<span style=color:#75715e># macOS client</span>
PublicKey <span style=color:#f92672>=</span> &lt;insert value from client.pubkey here&gt;
PresharedKey <span style=color:#f92672>=</span> &lt;insert value from preshared.key here&gt;
AllowedIPs <span style=color:#f92672>=</span> 10.0.0.2/32

<span style=color:#f92672>[</span>Peer<span style=color:#f92672>]</span>
<span style=color:#75715e># iOS client</span>
PublicKey <span style=color:#f92672>=</span> &lt;insert value from ios.pubkey here&gt;
PresharedKey <span style=color:#f92672>=</span> &lt;insert value from preshared.key here&gt;
AllowedIPs <span style=color:#f92672>=</span> 10.0.0.3/32, fd86:ea04:1115::2/128
</code></pre></div><p>All that is left is to enable and start the wireguard service via systemctl:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ systemctl enable wg-quick@wg0.service
$ systemctl start wg-quick@wg0.service
</code></pre></div><p>If everything went according to plan, the service will be started and a new network interface <code>wg0</code> should be visible via <code>ip link show</code>. For the macOS client, the configuration file needs to look like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># ~/.config/wireguard/client.conf</span>

<span style=color:#f92672>[</span>Interface<span style=color:#f92672>]</span>
Address <span style=color:#f92672>=</span> 10.0.0.2/24
PrivateKey <span style=color:#f92672>=</span> &lt;insert value from client.privkey here&gt;
ListenPort <span style=color:#f92672>=</span> <span style=color:#ae81ff>51820</span>

<span style=color:#f92672>[</span>Peer<span style=color:#f92672>]</span>
PublicKey <span style=color:#f92672>=</span> &lt;insert value from server.pubkey here&gt;
PresharedKey <span style=color:#f92672>=</span> &lt;insert value from preshared.key here&gt;
<span style=color:#75715e># We route everything over the VPN, once the tunnel is established.</span>
<span style=color:#75715e># If you dont want that, specify the IP addresses and networks you</span>
<span style=color:#75715e># want to route here.</span>
AllowedIPs <span style=color:#f92672>=</span> AllowedIPs <span style=color:#f92672>=</span> 0.0.0.0/0, ::/0
Endpoint <span style=color:#f92672>=</span> &lt;insert VPN server public IP here&gt;:51820
<span style=color:#75715e># This is for if you’re behind a NAT and want the connection to be kept alive.</span>
PersistentKeepalive <span style=color:#f92672>=</span> <span style=color:#ae81ff>25</span>
</code></pre></div><p>After the configuration is created, we bring up the tunnel via <code>sudo wg-quick up ~/.config/wireguard/client.conf</code>.</p>
<p>To make our lives easier, we are preparing the iOS configuration on the Mac and create a QR code that we can use to configure the Wireguard app on the iPhone. But first the configuration file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># ~/.config/wireguard/ios.conf</span>

<span style=color:#f92672>[</span>Interface<span style=color:#f92672>]</span>
Address <span style=color:#f92672>=</span> 10.0.0.3/24, fd86:ea04:1115::2/128
PrivateKey <span style=color:#f92672>=</span> &lt;insert value from ios.privkey here&gt;
ListenPort <span style=color:#f92672>=</span> <span style=color:#ae81ff>51820</span>
<span style=color:#75715e># The iOS client seems to need a DNS server value here,</span>
<span style=color:#75715e># otherwise I was not able to resolve anything while</span>
<span style=color:#75715e># connected to the VPN. Choose your favorite DNS resolvers here</span>
DNS <span style=color:#f92672>=</span> 9.9.9.9, 8.8.8.8

<span style=color:#f92672>[</span>Peer<span style=color:#f92672>]</span>
PublicKey <span style=color:#f92672>=</span> &lt;insert value from server.pubkey here&gt;
PresharedKey <span style=color:#f92672>=</span> &lt;insert value from preshared.key here&gt;
<span style=color:#75715e># We route everything over the VPN, once the tunnel is established.</span>
<span style=color:#75715e># If you dont want that, specify the IP addresses and networks you</span>
<span style=color:#75715e># want to route here.</span>
AllowedIPs <span style=color:#f92672>=</span> AllowedIPs <span style=color:#f92672>=</span> 0.0.0.0/0, ::/0
Endpoint <span style=color:#f92672>=</span> &lt;insert VPN server public IP here&gt;:51820
<span style=color:#75715e># This is for if you’re behind a NAT and want the connection to be kept alive.</span>
PersistentKeepalive <span style=color:#f92672>=</span> <span style=color:#ae81ff>25</span>
</code></pre></div><p>Now that we are finished with the iOS configuration, we will generate the QR code via <code>qrencode -t ansiutf8 ~/.config/wireguard/ios.conf</code>. The code can now be used in the iOS app to add a new tunnel configuration.</p>
<h2 id=final-thoughts>Final thoughts</h2>
<p>Even though Wireguard is marked as &ldquo;alpha&rdquo; everywhere, it seems to be very stable and quite usable. There is even a package for the <a href=https://community.ubnt.com/t5/EdgeRouter/Release-WireGuard-for-EdgeRouter/td-p/1904764>Ubiquiti Edge Router</a> available. Everyone who knows their way around a Cisco or Juniper console will find themselves right at home.</p>
<p>My impression so far: It is stable, performant (enough), very easy to install, easy to configure and, last but not least, very low maintenance. The iPhone app is great and integrates very well into iOS. After I had such a great experience so far, I will test the native macOS Wireguard app in the next couple of days.</p>
<p>I think I&rsquo;ll keep it!</p>
</main>
<aside class="tags grid-canvas">
<ul class=taglist>
<li class=tag><a class=tag-link href=/tags/networking title="Posts tagged with networking"><i class="bi bi-tag"></i>networking</a></li>
<li class=tag><a class=tag-link href=/tags/vpn title="Posts tagged with vpn"><i class="bi bi-tag"></i>vpn</a></li>
<li class=tag><a class=tag-link href=/tags/linux title="Posts tagged with linux"><i class="bi bi-tag"></i>linux</a></li>
<li class=tag><a class=tag-link href=/tags/macos title="Posts tagged with macos"><i class="bi bi-tag"></i>macos</a></li>
<li class=tag><a class=tag-link href=/tags/ios title="Posts tagged with ios"><i class="bi bi-tag"></i>ios</a></li>
<li class=tag><a class=tag-link href=/tags/en title="Posts tagged with en"><i class="bi bi-tag"></i>en</a></li>
</ul>
</aside>
</article>
</main>
<div class=footer>
<div class=grid-canvas>
<div class=footer-nav>
<div class=notice>© 2022 Jason Friedrich</div>
<nav class=header-nav>
<div class=secondary-nav>
<a class="header-nav-entry desktop-nav-entry" title=Home href=/><i role=img class="bi bi-house-fill"></i><span>Home</span></a>
<a class="header-nav-entry desktop-nav-entry" title=About href=/about/><i role=img class="bi bi-person-fill"></i><span>About</span></a>
<a class="header-nav-entry desktop-nav-entry" title=Twitter href=https://twitter.com/jbfriedrich><i role=img class="bi bi-twitter"></i><span>Twitter</span></a>
<a class=header-nav-entry title="Top " href=#top>&#8593; Top &#8593;</a>
</div>
</nav>
</div>
</div>
</div>
</body>
</html>